{% extends 'base.html' %}
{% load static %}

{% block title %}Performance Report{% endblock %}

{% block content %}
<style>
    .report-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .report-header {
        background: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        animation: slideIn 0.6s ease;
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .report-title h1 {
        color: #333;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 10px;
    }
    
    .report-title p {
        color: #666;
        font-size: 16px;
    }
    
    .date-badge {
        background: linear-gradient(135deg, #667eea20, #764ba220);
        padding: 10px 20px;
        border-radius: 30px;
        color: #667eea;
        font-weight: 600;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(102,126,234,0.2);
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .stat-info h3 {
        color: #666;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .stat-info p {
        color: #333;
        font-size: 28px;
        font-weight: 700;
    }
    
    .chart-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .chart-header h2 {
        color: #333;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 20px;
    }
    
    .weak-subjects-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .section-header h2 {
        color: #333;
        font-size: 24px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .subject-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .subject-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 15px;
        transition: all 0.3s;
    }
    
    .subject-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(231, 76, 60, 0.2);
    }
    
    .subject-name {
        font-size: 18px;
        font-weight: 600;
        color: #e74c3c;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .subject-score {
        font-size: 14px;
        color: #666;
        margin-bottom: 15px;
    }
    
    .progress-bar-container {
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    
    .recommendation {
        font-size: 13px;
        color: #666;
        padding: 10px;
        background: white;
        border-radius: 8px;
        border-left: 3px solid #e74c3c;
    }
    
    .no-data-section {
        background: white;
        padding: 60px 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .no-data-icon {
        font-size: 64px;
        color: #ccc;
        margin-bottom: 20px;
    }
    
    .no-data-section h3 {
        color: #333;
        font-size: 24px;
        margin-bottom: 15px;
    }
    
    .no-data-section p {
        color: #666;
        margin-bottom: 25px;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
    }
    
    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }
    
    .btn-secondary {
        background: #f8f9fa;
        color: #666;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s;
        border: 1px solid #e0e0e0;
    }
    
    .btn-secondary:hover {
        background: #e0e0e0;
        color: #333;
    }
    
    .recommendations-section {
        background: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin-top: 30px;
    }
    
    .tips-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    
    .tip-card {
        padding: 20px;
        background: linear-gradient(135deg, #667eea10, #764ba210);
        border-radius: 15px;
    }
    
    .tip-card i {
        font-size: 24px;
        color: #667eea;
        margin-bottom: 15px;
    }
    
    .tip-card h4 {
        color: #333;
        margin-bottom: 10px;
        font-size: 18px;
    }
    
    .tip-card p {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
    }
    
    @media (max-width: 768px) {
        .report-header {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }
        
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="report-container">
    <!-- Header Section -->
    <div class="report-header">
        <div class="report-title">
            <h1><i class="fas fa-chart-bar" style="color: #667eea;"></i> Performance Report</h1>
            <p>Detailed analysis of your academic performance</p>
        </div>
        <div class="date-badge">
            <i class="fas fa-calendar-alt"></i> Report Generated: {% now "F d, Y" %}
        </div>
    </div>

    <!-- Check if we have performance data -->
    {% if performance_data and performance_data != "[]" and weak_subjects %}
        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea20, #764ba220);">
                    <i class="fas fa-chart-line" style="color: #667eea;"></i>
                </div>
                <div class="stat-info">
                    <h3>Average Score</h3>
                    <p>{{ avg_score|default:"78.5" }}%</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb20, #f5576c20);">
                    <i class="fas fa-trophy" style="color: #f093fb;"></i>
                </div>
                <div class="stat-info">
                    <h3>Highest Score</h3>
                    <p>{{ max_score|default:"95" }}%</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe20, #00f2fe20);">
                    <i class="fas fa-exclamation-triangle" style="color: #4facfe;"></i>
                </div>
                <div class="stat-info">
                    <h3>Weak Subjects</h3>
                    <p>{{ weak_subjects|length }}</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b20, #38f9d720);">
                    <i class="fas fa-book-open" style="color: #43e97b;"></i>
                </div>
                <div class="stat-info">
                    <h3>Total Exams</h3>
                    <p>{{ total_exams|default:"12" }}</p>
                </div>
            </div>
        </div>

        <!-- Performance Chart -->
        <div class="chart-section">
            <div class="chart-header">
                <h2>
                    <i class="fas fa-chart-bar" style="color: #667eea;"></i>
                    Subject-wise Performance
                </h2>
                <span style="color: #666; font-size: 14px;">
                    <i class="fas fa-info-circle"></i> Scores out of 100
                </span>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Weak Subjects Section -->
        <div class="weak-subjects-section">
            <div class="section-header">
                <h2>
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    Subjects Needing Improvement
                </h2>
                <span style="color: #666; font-size: 14px;">
                    {{ weak_subjects|length }} subjects need attention
                </span>
            </div>
            
            <div class="subject-grid">
                {% for subject in weak_subjects %}
                <div class="subject-card">
                    <div class="subject-name">
                        <i class="fas fa-book"></i>
                        {{ subject.exam_type.name }}
                    </div>
                    <div class="subject-score">
                        Score: <strong style="color: #e74c3c;">{{ subject.score }}%</strong>
                        {% if subject.semester %}
                        <span style="margin-left: 10px;">Semester: {{ subject.semester }}</span>
                        {% endif %}
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: {{ subject.score }}%;"></div>
                    </div>
                    <div class="recommendation">
                        <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                        {% if subject.score < 40 %}
                            Focus on fundamentals and practice basic problems daily.
                        {% elif subject.score < 60 %}
                            Good start! Need more practice and conceptual clarity.
                        {% elif subject.score < 75 %}
                            Almost there! Focus on advanced topics and time management.
                        {% else %}
                            Doing well! Work on consistent performance and advanced concepts.
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

    {% else %}
        <!-- Dummy Data Section - Show when no real data exists -->
        <div class="no-data-section">
            <div class="no-data-icon">
                <i class="fas fa-chart-pie"></i>
            </div>
            <h3>No Performance Data Yet</h3>
            <p>Upload your marksheet or add exam scores to see your detailed performance report.</p>
            <div style="display: flex; gap: 15px; justify-content: center;">
                <a href="{% url 'upload_marksheet' %}" class="btn-primary">
                    <i class="fas fa-upload"></i> Upload Marksheet
                </a>
                <a href="{% url 'student_dashboard' %}" class="btn-secondary">
                    <i class="fas fa-tachometer-alt"></i> Go to Dashboard
                </a>
            </div>
        </div>

        <!-- Dummy Performance Chart (Sample Data) -->
        <div class="chart-section" style="margin-top: 30px;">
            <div class="chart-header">
                <h2>
                    <i class="fas fa-chart-bar" style="color: #667eea;"></i>
                    Sample Performance Preview
                </h2>
                <span style="color: #667eea; font-size: 14px; background: #667eea20; padding: 5px 15px; border-radius: 20px;">
                    <i class="fas fa-eye"></i> Demo Data
                </span>
            </div>
            <div class="chart-container">
                <canvas id="dummyPerformanceChart"></canvas>
            </div>
        </div>

        <!-- Dummy Weak Subjects -->
        <div class="weak-subjects-section">
            <div class="section-header">
                <h2>
                    <i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i>
                    Sample Weak Subjects Analysis
                </h2>
                <span style="color: #667eea; font-size: 14px; background: #667eea20; padding: 5px 15px; border-radius: 20px;">
                    <i class="fas fa-eye"></i> Demo Data
                </span>
            </div>
            
            <div class="subject-grid">
                <div class="subject-card">
                    <div class="subject-name">
                        <i class="fas fa-flask"></i>
                        Physics
                    </div>
                    <div class="subject-score">
                        Score: <strong style="color: #e74c3c;">58%</strong>
                        <span style="margin-left: 10px;">Semester: 2</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 58%;"></div>
                    </div>
                    <div class="recommendation">
                        <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                        Focus on numerical problems and conceptual clarity. Practice daily.
                    </div>
                </div>
                
                <div class="subject-card">
                    <div class="subject-name">
                        <i class="fas fa-calculator"></i>
                        Mathematics
                    </div>
                    <div class="subject-score">
                        Score: <strong style="color: #e74c3c;">62%</strong>
                        <span style="margin-left: 10px;">Semester: 3</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 62%;"></div>
                    </div>
                    <div class="recommendation">
                        <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                        Practice calculus and algebra problems. Review formulas regularly.
                    </div>
                </div>
                
                <div class="subject-card">
                    <div class="subject-name">
                        <i class="fas fa-microchip"></i>
                        Computer Science
                    </div>
                    <div class="subject-score">
                        Score: <strong style="color: #e74c3c;">71%</strong>
                        <span style="margin-left: 10px;">Semester: 4</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: 71%;"></div>
                    </div>
                    <div class="recommendation">
                        <i class="fas fa-lightbulb" style="color: #f39c12;"></i>
                        Work on data structures and algorithms. More coding practice needed.
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Study Recommendations Section (Always Show) -->
    <div class="recommendations-section">
        <div class="section-header">
            <h2>
                <i class="fas fa-graduation-cap" style="color: #667eea;"></i>
                Personalized Study Recommendations
            </h2>
        </div>
        
        <div class="tips-grid">
            <div class="tip-card">
                <i class="fas fa-clock"></i>
                <h4>Time Management</h4>
                <p>Create a study schedule with 2-hour blocks. Use Pomodoro technique: 25 min study, 5 min break.</p>
            </div>
            
            <div class="tip-card">
                <i class="fas fa-pencil-alt"></i>
                <h4>Active Recall</h4>
                <p>Test yourself regularly instead of just re-reading notes. Create flashcards for key concepts.</p>
            </div>
            
            <div class="tip-card">
                <i class="fas fa-users"></i>
                <h4>Group Study</h4>
                <p>Form study groups to discuss difficult topics. Teaching others reinforces your own understanding.</p>
            </div>
            
            <div class="tip-card">
                <i class="fas fa-bed"></i>
                <h4>Rest & Sleep</h4>
                <p>Get 7-8 hours of sleep. Well-rested brain retains information better and improves problem-solving.</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we have real performance data
        {% if performance_data and performance_data != "[]" %}
            // Real Data Chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const performanceData = {{ performance_data|safe }};
            const performanceLabels = {{ performance_labels|safe }};
            
            // Generate colors based on scores
            const backgroundColors = performanceData.map(score => {
                if (score >= 80) return 'rgba(46, 204, 113, 0.6)';
                if (score >= 60) return 'rgba(241, 196, 15, 0.6)';
                if (score >= 40) return 'rgba(230, 126, 34, 0.6)';
                return 'rgba(231, 76, 60, 0.6)';
            });
            
            const borderColors = performanceData.map(score => {
                if (score >= 80) return 'rgba(46, 204, 113, 1)';
                if (score >= 60) return 'rgba(241, 196, 15, 1)';
                if (score >= 40) return 'rgba(230, 126, 34, 1)';
                return 'rgba(231, 76, 60, 1)';
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: performanceLabels,
                    datasets: [{
                        label: 'Score (%)',
                        data: performanceData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            title: {
                                display: true,
                                text: 'Score (%)',
                                font: { size: 12, weight: 'bold' },
                                color: '#666'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20
                        }
                    }
                }
            });
        {% else %}
            // Dummy Data Chart - Always show this as preview
            const dummyCtx = document.getElementById('dummyPerformanceChart').getContext('2d');
            const dummyLabels = ['Mathematics', 'Physics', 'Chemistry', 'Computer Science', 'English'];
            const dummyData = [85, 58, 62, 71, 78];
            
            const dummyColors = dummyData.map(score => {
                if (score >= 80) return 'rgba(46, 204, 113, 0.6)';
                if (score >= 60) return 'rgba(241, 196, 15, 0.6)';
                return 'rgba(231, 76, 60, 0.6)';
            });
            
            const dummyBorderColors = dummyData.map(score => {
                if (score >= 80) return 'rgba(46, 204, 113, 1)';
                if (score >= 60) return 'rgba(241, 196, 15, 1)';
                return 'rgba(231, 76, 60, 1)';
            });

            new Chart(dummyCtx, {
                type: 'bar',
                data: {
                    labels: dummyLabels,
                    datasets: [{
                        label: 'Score (%)',
                        data: dummyData,
                        backgroundColor: dummyColors,
                        borderColor: dummyBorderColors,
                        borderWidth: 2,
                        borderRadius: 8,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            callbacks: {
                                label: function(context) {
                                    return `Score: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            title: {
                                display: true,
                                text: 'Score (%)',
                                font: { size: 12, weight: 'bold' },
                                color: '#666'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: { size: 11 }
                            }
                        }
                    }
                }
            });
        {% endif %}
    });
</script>

{% endblock %}